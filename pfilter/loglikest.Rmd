---
title: "Worked solution to Exercise 3.2"
author: "Aaron A. King"
output:
  html_document:
    toc: no
    toc_depth: 4
bibliography: ../sbied.bib
csl: ../jss.csl
params:
  prefix: llest/
---

\newcommand\prob[1]{\mathbb{P}\left[{#1}\right]}
\newcommand\expect[1]{\mathbb{E}\left[{#1}\right]}
\newcommand\var[1]{\mathrm{Var}\left[{#1}\right]}
\newcommand\dist[2]{\mathrm{#1}\left(#2\right)}
\newcommand\lik{\mathcal{L}}
\newcommand\loglik{\ell}

[Licensed under the Creative Commons Attribution-NonCommercial license](http://creativecommons.org/licenses/by-nc/4.0/).
Please share and remix noncommercially, mentioning its origin.  
![CC-BY_NC](../graphics/cc-by-nc.png)

```{r knitr-opts,include=FALSE,purl=FALSE,child="../setup.Rmd"}
```
```{r prelims,purl=TRUE,cache=FALSE}
library(plyr)
library(tidyverse)
library(pomp)
stopifnot(getRversion()>="4.0")
stopifnot(packageVersion("pomp")>="3.0")
set.seed(1221234211)
```

Model implementation

```{r read_chunk,include=FALSE,purl=TRUE,cache=FALSE}
knitr::read_chunk("model.R")
```
```{r model-construct}
```

Testing the particle filter:

```{r test}
measSIR %>% pfilter(Np=1000) -> pf
logLik(pf)
```

Now, we evaluate the dependence of log likelihood estimates 
on particle size and number of independent filters

```{r comps,eval=FALSE}
library(foreach)
library(doParallel)

registerDoParallel()

foreach (nfilt=c(10,100,1000),
  .combine=rbind,.inorder=FALSE,
  .options.multicore=list(set.seed=TRUE)) %:%
  foreach (Np=c(1000,10000,100000), .combine=rbind) %:%
  foreach (i=1:nfilt, .combine=rbind) %dopar% {
    measSIR %>% pfilter(Np=Np) -> pf
    logLik(pf) -> ll
    data.frame(nfilt=nfilt,Np=Np,loglik=ll)
  } -> lls
```
```{r comps-eval,include=FALSE}
bake(file="loglikest-pfilter.rds",
  seed=594717807L,kind="L'Ecuyer-CMRG",{
    <<comps>> 
    registerDoSEQ()
    lls
 }) -> lls
```

Violin plots are cute.

```{r plots}
lls %>%
  ggplot(aes(x=Np,y=loglik,fill=ordered(nfilt),
    group=interaction(nfilt,Np)))+
  geom_violin(draw_quantiles=c(0.1,0.5,0.9),alpha=0.7)+
  scale_x_log10(breaks=unique(lls$Np))+
  labs(fill="nfilt")
```

-----------

## [Back to main lesson](./index.html)
## [**R** codes for this document](http://raw.githubusercontent.com/kingaa/sbied/master/pfilter/loglikest.R)

-----------
